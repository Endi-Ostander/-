#include "timer.h"
#include "irq.h"
#include "console.h"
#include "serial.h"

static uint32_t tick = 0;

static void timer_callback(registers_t regs) {
    tick++;
    if (tick % 100 == 0) {
        console_write("[TIMER] 1 second passed\n");
        serial_write("[TIMER] 1 second passed\n");
    }
}

void timer_phase(int hz) {
    int divisor = 1193180 / hz;
    __asm__ volatile("outb %0, %1" : : "a"((uint8_t)(divisor & 0xFF)), "Nd"(0x40));
    __asm__ volatile("outb %0, %1" : : "a"((uint8_t)((divisor >> 8) & 0xFF)), "Nd"(0x40));
}

void timer_install(void) {
    irq_install_handler(0, timer_callback);
    timer_phase(100); // 100 Гц
}
